<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: var(--color-burnt-orange);
            color: var(--color-white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { filter: brightness(0.95); }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .user-profile {
            background: var(--color-light-cream);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid rgba(109,76,65,0.08);
        }
        .profile-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Dashboard Debug Test</h1>
        <p>This will help diagnose profile loading and logout issues</p>
        
        <div>
            <button onclick="testFirebaseInit()">1. Test Firebase Init</button>
            <button onclick="testAuthState()">2. Test Auth State</button>
            <button onclick="testUserProfile()">3. Test User Profile</button>
            <button onclick="testLogout()">4. Test Logout</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div id="status" class="status info">
            <strong>Status:</strong> Ready to test dashboard functionality
        </div>

        <div class="user-profile">
            <h3>üßë‚Äçüíº Current User Profile:</h3>
            <div class="profile-item"><strong>Name:</strong> <span id="current-name">Not loaded</span></div>
            <div class="profile-item"><strong>Email:</strong> <span id="current-email">Not loaded</span></div>
            <div class="profile-item"><strong>Role:</strong> <span id="current-role">Not loaded</span></div>
            <div class="profile-item"><strong>Auth Status:</strong> <span id="auth-status">Unknown</span></div>
            <div class="profile-item"><strong>LocalStorage:</strong> <span id="localStorage-status">Not checked</span></div>
        </div>

        <h3>Console Log:</h3>
        <div id="log" class="log">Click buttons above to start testing...\n</div>
    </div>

    <script type="module">
        import * as shim from './firebase-shim.js';

        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        let auth = shim.getAuth();
        let db = shim.getFirestore();

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[DASHBOARD DEBUG] ${message}`);
        }

        function setStatus(message, type = 'info') {
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            statusElement.innerHTML = `<div class="status ${statusClass}"><strong>Status:</strong> ${message}</div>`;
        }

        function updateProfileDisplay(userData, authUser) {
            document.getElementById('current-name').textContent = userData?.fullName || userData?.firstName || 'Not available';
            document.getElementById('current-email').textContent = userData?.email || authUser?.email || 'Not available';
            document.getElementById('current-role').textContent = userData?.role || 'Not available';
            document.getElementById('auth-status').textContent = authUser ? 'Authenticated (local)' : 'Not authenticated';

            const savedUser = localStorage.getItem('sf_user');
            document.getElementById('localStorage-status').textContent = savedUser ? 'Data found' : 'No data';
        }

        window.clearLog = function() {
            logElement.textContent = 'Log cleared...\n';
        }

        window.testFirebaseInit = async function() {
            addLog('üî• Testing local shim initialization...');
            setStatus('Testing local shim...', 'info');

            try {
                addLog('‚úÖ Local firebase shim loaded');
                addLog(`üîê Auth available: ${!!auth}`);
                addLog(`üóÑÔ∏è Local storage available: ${!!window.localStorage}`);
                setStatus('Local shim initialization successful!', 'success');
            } catch (error) {
                addLog('‚ùå Local shim initialization failed: ' + (error.message || error));
                setStatus('Local shim initialization failed: ' + (error.message || error), 'error');
            }
        }

        window.testAuthState = async function() {
            addLog('üë§ Testing Authentication State (local)...');
            setStatus('Testing authentication state...', 'info');

            try {
                addLog('üîç Checking current auth state...');
                shim.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        addLog('‚úÖ User is authenticated (local)!');
                        addLog(`üìß Email: ${user.email}`);
                        addLog(`üÜî UID: ${user.uid}`);
                        updateProfileDisplay(null, user);
                        setStatus('User is authenticated (local)', 'success');
                    } else {
                        addLog('‚ùå No user is currently authenticated (local)');
                        updateProfileDisplay(null, null);
                        setStatus('No user authenticated', 'error');
                    }
                });
            } catch (error) {
                addLog('‚ùå Authentication state test failed: ' + (error.message || error));
                setStatus('Authentication test failed: ' + (error.message || error), 'error');
            }
        }

        window.testUserProfile = async function() {
            addLog('üë§ Testing User Profile Loading (local)...');
            setStatus('Testing user profile loading...', 'info');

            const user = auth.currentUser;
            if (!user) {
                addLog('‚ùå No authenticated user found locally. Use signup/login flows to create a user.');
                setStatus('No authenticated user', 'error');
                return;
            }

            try {
                const userDoc = await shim.getDoc(shim.doc(db, 'users', user.uid));

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    addLog('‚úÖ User document found in local storage!');
                    addLog(`üìõ Full Name: ${userData.fullName || 'Not set'}`);
                    addLog(`üìß Email: ${userData.email || 'Not set'}`);
                    addLog(`üé≠ Role: ${userData.role || 'Not set'}`);

                    const completeUserData = {
                        ...userData,
                        email: user.email,
                        uid: user.uid
                    };
                    localStorage.setItem('sf_user', JSON.stringify(completeUserData));
                    addLog('üíæ User data saved to localStorage');

                    updateProfileDisplay(completeUserData, user);
                    setStatus('User profile loaded successfully!', 'success');
                } else {
                    addLog('‚ùå No user document found locally');
                    const fallbackData = {
                        fullName: user.displayName || 'User',
                        email: user.email,
                        uid: user.uid,
                        role: 'farmer'
                    };
                    updateProfileDisplay(fallbackData, user);
                    setStatus('User document not found locally', 'error');
                }
            } catch (error) {
                addLog('‚ùå Profile loading failed: ' + (error.message || error));
                setStatus('Profile loading failed: ' + (error.message || error), 'error');
            }
        }

        window.testLogout = async function() {
            addLog('üö™ Testing Logout Functionality...');
            setStatus('Testing logout...', 'info');
            
            if (!auth) {
                addLog('‚ùå Firebase not initialized. Run test 1 first.');
                setStatus('Firebase not initialized', 'error');
                return;
            }
            
            try {
                const { signOut } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js");
                
                const user = auth.currentUser;
                if (!user) {
                    addLog('‚ö†Ô∏è No user is currently signed in');
                    setStatus('No user to sign out', 'info');
                    return;
                }
                
                addLog(`üîì Signing out user: ${user.email}`);
                await signOut(auth);
                addLog('‚úÖ Firebase signOut successful');
                
                // Clear localStorage
                localStorage.clear();
                addLog('üßπ localStorage cleared');
                
                // Check auth state after logout
                setTimeout(() => {
                    const currentUser = auth.currentUser;
                    if (currentUser) {
                        addLog('‚ùå User still authenticated after logout!');
                        setStatus('Logout failed - user still authenticated', 'error');
                    } else {
                        addLog('‚úÖ User successfully signed out');
                        updateProfileDisplay(null, null);
                        setStatus('Logout successful!', 'success');
                    }
                }, 1000);
                
            } catch (error) {
                addLog('‚ùå Logout failed: ' + error.message);
                setStatus('Logout failed: ' + error.message, 'error');
            }
        }

        // Auto-initialize Firebase on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                addLog('üöÄ Auto-initializing Firebase...');
                window.testFirebaseInit().then(() => {
                    setTimeout(() => {
                        window.testAuthState();
                    }, 1000);
                });
            }, 1000);
        });
    </script>
</body>
</html>